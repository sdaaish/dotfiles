#!/usr/bin/env -S uv run --script
#  -*- mode: python; -*-
#
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "pandas",
#     "openpyxl",
# ]
# ///

import argparse
import os
import sys
from datetime import datetime

import pandas as pd
from openpyxl.styles import Font
from openpyxl.utils import get_column_letter


def main() -> None:
    parser = argparse.ArgumentParser(description="Convert CSV to Excel")
    parser.add_argument("-c", "--csv", required=True, help="Input CSV file")
    parser.add_argument("-f", "--force", action="store_true", help="Overwrite existing Excel file")
    args = parser.parse_args()

    csv_path = args.csv
    if not os.path.exists(csv_path):
        print(f"Error: CSV file '{csv_path}' does not exist.", file=sys.stderr)
        sys.exit(1)

    base, _ = os.path.splitext(csv_path)
    excel_path = f"{base}.xlsx"

    if os.path.exists(excel_path) and not args.force:
        print(f"Error: Excel file '{excel_path}' already exists. Use -f to overwrite.", file=sys.stderr)
        sys.exit(1)

    try:
        # Determine columns from header to handle rows with trailing commas
        cols = pd.read_csv(csv_path, nrows=0).columns.tolist()
        df = pd.read_csv(csv_path, usecols=cols)

        sheet_name = f"{datetime.now().strftime('%Y-%m-%d')}"

        with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name=sheet_name)
            # Apply bold font to the header row
            worksheet = writer.sheets[sheet_name]
            for cell in worksheet[1]:
                cell.font = Font(bold=True)

            # Auto-size columns based on the first 10 rows
            for i, col in enumerate(df.columns):
                # Calculate the maximum length in the first 10 rows (including header)
                # Map everything to str to handle NaNs correctly
                data_lengths = df[col].head(10).map(str).apply(len)
                max_len = max(
                    data_lengths.max() if not data_lengths.empty else 0,
                    len(str(col))
                ) + 2  # Add a little extra space
                column_width = min(max_len, 100)
                column_letter = get_column_letter(i + 1)
                worksheet.column_dimensions[column_letter].width = column_width

    except Exception as e:
        print(f"Error during conversion: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
