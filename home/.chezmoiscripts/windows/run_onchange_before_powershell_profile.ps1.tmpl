{{ if eq .chezmoi.os "windows"}}

# Setup the powershell profile for CurrentUserAllHosts.
# For both Desktop and Core version.

$content = @'
# This file is managed by Chezmoi, don't edit it
$starttime = Get-Date

# Exclude Powershell ISE from profiles and aliases for now.
if ($Host -match "ISE"){
}
else {
    switch ($env:TERM){
        "emacs" { . ~/.config/powershell/profile-emacs.ps1 }
        "dumb" { . ~/.config/powershell/profile-emacs.ps1 }
        "vscode" { . ~/.config/powershell/profile-emacs.ps1 }
        default { . ~/.config/powershell/profile.ps1 }
    }
}
'@

# Find the base of the Documents folder
$BaseDir = [System.Environment]::GetFolderPath([System.Environment+SpecialFolder]::Mydocuments)

"PowerShell", "WindowsPowerShell" | foreach {

    if(-not(Test-Path (Join-Path $BaseDir $_) -PathType Container)){
        New-Item -Path $BaseDir -Name $_ -ItemType Directory
    }
    $parent = Join-Path $BaseDir $_
    $config = Join-Path $parent "profile.ps1"
    Set-Content -Path $config -Value $content -Encoding UTF8 -NoNewLine -Force
}

# Setup the config file for PowerShell 7
[string]$path = "{0}{1}" -f $HOME,"\.local\share\PowerShell\Modules"
$path = $path -replace "\\","\\"

$content = @"
{
    "Microsoft.PowerShell.ExecutionPolicy" : "RemoteSigned",
    "PSModulePath" : "$path"
}
"@

$config = Join-Path $BaseDir PowerShell
$config = Join-Path $config "powershell.config.json"

Set-Content -Path $config -Value $content

{{ end }}
